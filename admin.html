<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>管理画面</title>

<style>
body{margin:0;font-family:system-ui;background:#0b0f16;color:#fff;padding:20px;}
button{margin:4px 2px;padding:6px 10px;background:#1f2937;color:#fff;border:none;border-radius:6px;}
input, textarea, select{width:100%;margin:6px 0;padding:6px;}
.panel{background:#111827;padding:12px;border-radius:8px;margin-bottom:20px;}
.item{background:#1f2937;padding:8px;border-radius:6px;margin:6px 0;}
.categoryHeader{background:#374151;padding:8px;border-radius:6px;cursor:pointer;margin-top:8px;}
.preview{margin-top:10px;padding:10px;background:#0f172a;border-radius:8px;display:none;}
img{max-width:100%;border-radius:8px;margin-top:10px;}
a{color:#60a5fa;word-break:break-all;}
hr{border:none;border-top:1px solid rgba(255,255,255,.12);margin:10px 0;}
.small{opacity:.8;font-size:12px;}
</style>
</head>

<body>

<h2>管理画面</h2>

<button onclick="login()">パスワード入力</button>
<button onclick="logout()">ログアウト</button>

<div id="mainPanel" style="display:none;">

  <div class="panel">
    <h3>カテゴリ追加</h3>
    <input id="catName" placeholder="カテゴリ名">
    <button onclick="addCategory()">カテゴリ追加</button>
    <div class="small">※カテゴリは下の商品一覧で「▶/▼」で開閉できます</div>
  </div>

  <div class="panel">
    <h3>商品追加</h3>

    <input id="searchBox" placeholder="商品検索（表示中の一覧を絞り込み）" oninput="renderProducts()">

    <select id="productCategory"></select>
    <input id="pName" placeholder="商品名">
    <input id="pImage" placeholder="画像URL（任意）">
    <textarea id="pDesc" placeholder="説明（改行OK・URL可）" rows="5"></textarea>
    <button onclick="addProduct()">商品追加</button>

    <div id="productList"></div>

    <div id="productPreview" class="preview"></div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, deleteDoc, doc,
  updateDoc, onSnapshot, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAii9UA3YBztj3XE8QErStcf-TpIkFJYWQ",
  authDomain: "mtgroup-df495.firebaseapp.com",
  projectId: "mtgroup-df495.firebaseapp.com" ? "mtgroup-df495" : "mtgroup-df495",
  storageBucket: "mtgroup-df495.firebasestorage.app",
  messagingSenderId: "33007954637",
  appId: "1:33007954637:web:0a1c249df6764f8d855784"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ADMIN_PASSWORD = "1234";              // ←好きなパスワード
const LOGIN_KEY = "admin_login_time";
const LOGIN_DURATION = 24 * 60 * 60 * 1000; // 24h

let categories = [];
let products = [];
let openCategories = {}; // { [catName]: true/false }

const productList = document.getElementById("productList");
const productCategory = document.getElementById("productCategory");
const productPreview = document.getElementById("productPreview");

/* ====== 表示用の安全処理（改行 + URLリンク） ====== */
function escapeHtml(str){
  return String(str ?? "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}
function linkifySafe(text){
  let s = escapeHtml(text ?? "");
  s = s.replace(/\n/g, "<br>");
  s = s.replace(/(https?:\/\/[^\s<]+)/g,
    '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
  return s;
}

/* ====== 24h ログイン保持 ====== */
function showPanel(){ document.getElementById("mainPanel").style.display = "block"; }

function checkAutoLogin(){
  const t = localStorage.getItem(LOGIN_KEY);
  if(!t) return;
  if(Date.now() - Number(t) < LOGIN_DURATION){
    showPanel();
  }else{
    localStorage.removeItem(LOGIN_KEY);
  }
}

window.login = function(){
  const pass = prompt("管理者パスワードを入力");
  if(pass === ADMIN_PASSWORD){
    localStorage.setItem(LOGIN_KEY, String(Date.now()));
    showPanel();
  }else{
    alert("パスワードが違います");
  }
};

window.logout = function(){
  localStorage.removeItem(LOGIN_KEY);
  location.reload();
};

/* ====== 追加 ====== */
window.addCategory = async function(){
  const name = document.getElementById("catName").value.trim();
  if(!name) return;

  await addDoc(collection(db,"categories"), {
    name,
    order: Date.now()
  });

  document.getElementById("catName").value = "";
};

window.addProduct = async function(){
  const category = productCategory.value;
  const name = document.getElementById("pName").value.trim();
  const image = document.getElementById("pImage").value.trim();
  const desc = document.getElementById("pDesc").value;

  if(!category || !name){
    alert("カテゴリと商品名は必須です");
    return;
  }

  await addDoc(collection(db,"products"),{
    category, name, image, desc,
    order: Date.now()
  });

  document.getElementById("pName").value = "";
  document.getElementById("pImage").value = "";
  document.getElementById("pDesc").value = "";
};

/* ====== 編集 ====== */
window.editCategory = async function(id, oldName){
  const newName = prompt("カテゴリ名", oldName);
  if(newName === null) return;
  const v = newName.trim();
  if(!v) return;
  await updateDoc(doc(db,"categories",id), { name: v });
};

window.editProduct = async function(id){
  const p = products.find(x => x.id === id);
  if(!p) return;

  const newName = prompt("商品名", p.name ?? "");
  if(newName === null) return;

  const newDesc = prompt("説明（改行OK）", p.desc ?? "");
  if(newDesc === null) return;

  const newImage = prompt("画像URL（空でもOK）", p.image ?? "");
  if(newImage === null) return;

  await updateDoc(doc(db,"products",id), {
    name: (newName || "").trim(),
    desc: newDesc,
    image: (newImage || "").trim()
  });
};

/* ====== 削除 ====== */
window.deleteProduct = async function(id){
  if(confirm("商品を削除しますか？")){
    await deleteDoc(doc(db,"products",id));
  }
};

/* ====== プレビュー（自動切替） ====== */
window.showPreviewById = function(id){
  const p = products.find(x => x.id === id);
  if(!p) return;

  productPreview.style.display = "block";
  productPreview.innerHTML = `
    <div class="small">プレビュー（別の商品を押すと自動で切り替わります）</div>
    <hr>
    <div><strong>${escapeHtml(p.name)}</strong></div>
    <div class="small">${escapeHtml(p.category)}</div>
    <p style="line-height:1.6;">${linkifySafe(p.desc)}</p>
    ${p.image ? `<img src="${escapeHtml(p.image)}" alt="">` : ""}
  `;
};

/* ====== 折りたたみ ====== */
window.toggleCategory = function(name){
  openCategories[name] = !openCategories[name];
  renderProducts();
};

/* ====== 並び替え（カテゴリ） ====== */
async function swapOrder(collectionName, idA, orderA, idB, orderB){
  await updateDoc(doc(db, collectionName, idA), { order: orderB });
  await updateDoc(doc(db, collectionName, idB), { order: orderA });
}

window.moveCategoryUp = async function(catIndex){
  if(catIndex <= 0) return;
  const a = categories[catIndex];
  const b = categories[catIndex - 1];
  await swapOrder("categories", a.id, a.order, b.id, b.order);
};

window.moveCategoryDown = async function(catIndex){
  if(catIndex >= categories.length - 1) return;
  const a = categories[catIndex];
  const b = categories[catIndex + 1];
  await swapOrder("categories", a.id, a.order, b.id, b.order);
};

/* ====== 並び替え（商品）—★ここが修正版：カテゴリ内（＋検索で表示中）で隣と入れ替え ====== */
function getCurrentKeyword(){
  return (document.getElementById("searchBox").value || "").toLowerCase().trim();
}

function getVisibleProductsInCategory(catName){
  const kw = getCurrentKeyword();
  return products
    .filter(p => p.category === catName)
    .filter(p => (p.name || "").toLowerCase().includes(kw))
    .sort((x,y) => (x.order ?? 0) - (y.order ?? 0));
}

window.moveProductUp = async function(catName, productId){
  const list = getVisibleProductsInCategory(catName);
  const idx = list.findIndex(x => x.id === productId);
  if(idx <= 0) return;
  const a = list[idx];
  const b = list[idx - 1];
  await swapOrder("products", a.id, a.order, b.id, b.order);
};

window.moveProductDown = async function(catName, productId){
  const list = getVisibleProductsInCategory(catName);
  const idx = list.findIndex(x => x.id === productId);
  if(idx < 0 || idx >= list.length - 1) return;
  const a = list[idx];
  const b = list[idx + 1];
  await swapOrder("products", a.id, a.order, b.id, b.order);
};

/* ====== Firestore 監視 ====== */
onSnapshot(query(collection(db,"categories"), orderBy("order")), snap=>{
  categories = [];
  productCategory.innerHTML = "";

  snap.forEach(d => categories.push({ id:d.id, ...d.data() }));

  categories.forEach(cat=>{
    const opt = document.createElement("option");
    opt.value = cat.name;
    opt.textContent = cat.name;
    productCategory.appendChild(opt);

    // 初回は閉じておきたいなら何もしない
    // 初回から開いておきたいなら ↓
    // if(openCategories[cat.name] === undefined) openCategories[cat.name] = true;
  });

  renderProducts();
});

onSnapshot(query(collection(db,"products"), orderBy("order")), snap=>{
  products = [];
  snap.forEach(d => products.push({ id:d.id, ...d.data() }));
  renderProducts();
});

/* ====== 描画（折りたたみ + 検索 + ボタン） ====== */
window.renderProducts = function(){
  productList.innerHTML = "";
  const kw = getCurrentKeyword();

  categories.forEach((cat, catIndex) => {
    const isOpen = !!openCategories[cat.name];

    const header = document.createElement("div");
    header.className = "categoryHeader";
    header.innerHTML = `
      ${(isOpen ? "▼" : "▶")} ${escapeHtml(cat.name)}
      <button onclick="event.stopPropagation(); moveCategoryUp(${catIndex})">▲</button>
      <button onclick="event.stopPropagation(); moveCategoryDown(${catIndex})">▼</button>
      <button onclick="event.stopPropagation(); editCategory('${cat.id}', ${JSON.stringify(cat.name)})">編集</button>
    `;
    header.onclick = () => toggleCategory(cat.name);
    productList.appendChild(header);

    if(!isOpen) return;

    const list = products
      .filter(p => p.category === cat.name)
      .filter(p => (p.name || "").toLowerCase().includes(kw))
      .sort((x,y) => (x.order ?? 0) - (y.order ?? 0));

    if(list.length === 0){
      const empty = document.createElement("div");
      empty.className = "item";
      empty.textContent = kw ? "（検索に一致する商品がありません）" : "（このカテゴリに商品がありません）";
      productList.appendChild(empty);
      return;
    }

    list.forEach((p) => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        ${escapeHtml(p.name)}
        <button onclick="showPreviewById('${p.id}')">表示</button>
        <button onclick="editProduct('${p.id}')">編集</button>
        <button onclick="moveProductUp(${JSON.stringify(cat.name)}, '${p.id}')">▲</button>
        <button onclick="moveProductDown(${JSON.stringify(cat.name)}, '${p.id}')">▼</button>
        <button onclick="deleteProduct('${p.id}')">削除</button>
      `;
      productList.appendChild(div);
    });
  });
};

/* 起動時 */
checkAutoLogin();
</script>

</body>
</html>
