<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>管理画面</title>

<style>
body{margin:0;font-family:system-ui;background:#0b0f16;color:#fff;padding:20px;}
button{margin:4px 2px;padding:6px 10px;background:#1f2937;color:#fff;border:none;border-radius:6px;}
input, textarea, select{width:100%;margin:6px 0;padding:6px;}
.panel{background:#111827;padding:12px;border-radius:8px;margin-bottom:20px;}
.item{background:#1f2937;padding:8px;border-radius:6px;margin:6px 0;}
.categoryHeader{background:#374151;padding:8px;border-radius:6px;cursor:pointer;margin-top:8px;}
.preview{margin-top:10px;padding:10px;background:#0f172a;border-radius:8px;display:none;}
img{max-width:100%;border-radius:8px;margin-top:10px;}
a{color:#60a5fa;}
</style>
</head>

<body>

<h2>管理画面</h2>
<button onclick="login()">パスワード入力</button>
<button onclick="logout()">ログアウト</button>

<div id="mainPanel" style="display:none;">

<div class="panel">
<h3>カテゴリ追加</h3>
<input id="catName" placeholder="カテゴリ名">
<button onclick="addCategory()">カテゴリ追加</button>
</div>

<div class="panel">
<h3>商品追加</h3>

<select id="productCategory"></select>
<input id="pName" placeholder="商品名">
<input id="pImage" placeholder="画像URL">
<textarea id="pDesc" placeholder="説明"></textarea>
<button onclick="addProduct()">商品追加</button>

<div id="productList"></div>
<div id="productPreview" class="preview"></div>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
getFirestore, collection, addDoc, deleteDoc, doc,
updateDoc, onSnapshot, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyAii9UA3YBztj3XE8QErStcf-TpIkFJYWQ",
authDomain: "mtgroup-df495.firebaseapp.com",
projectId: "mtgroup-df495",
storageBucket: "mtgroup-df495.firebasestorage.app",
messagingSenderId: "33007954637",
appId: "1:33007954637:web:0a1c249df6764f8d855784"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ADMIN_PASSWORD="1234";
const LOGIN_KEY="admin_login_time";
const LOGIN_DURATION=24*60*60*1000;

let categories=[];
let products=[];
let openCategories={};

const productList=document.getElementById("productList");
const productCategory=document.getElementById("productCategory");
const productPreview=document.getElementById("productPreview");

/* ログイン */
function checkAutoLogin(){
const t=localStorage.getItem(LOGIN_KEY);
if(t && Date.now()-t<LOGIN_DURATION){
document.getElementById("mainPanel").style.display="block";
}
}

window.login=function(){
const pass=prompt("パスワード");
if(pass===ADMIN_PASSWORD){
localStorage.setItem(LOGIN_KEY,Date.now());
document.getElementById("mainPanel").style.display="block";
}
}

window.logout=function(){
localStorage.removeItem(LOGIN_KEY);
location.reload();
}

/* カテゴリ追加 */
window.addCategory=async function(){
const name=document.getElementById("catName").value;
if(!name) return;
await addDoc(collection(db,"categories"),{name,order:Date.now()});
document.getElementById("catName").value="";
}

/* 商品追加 */
window.addProduct=async function(){
const category=productCategory.value;
const name=document.getElementById("pName").value;
const desc=document.getElementById("pDesc").value;
const image=document.getElementById("pImage").value;

if(!category||!name) return;

await addDoc(collection(db,"products"),{
category,name,desc,image,order:Date.now()
});
}

/* 編集 */
window.editProduct=async function(id,p){
const name=prompt("商品名",p.name);
if(name===null) return;
const desc=prompt("説明",p.desc||"");
if(desc===null) return;
const image=prompt("画像URL",p.image||"");
await updateDoc(doc(db,"products",id),{name,desc,image});
}

/* 並び替え */
async function swapOrder(idA,orderA,idB,orderB){
await updateDoc(doc(db,"products",idA),{order:orderB});
await updateDoc(doc(db,"products",idB),{order:orderA});
}

window.moveProductUp=async function(id){
const sorted=[...products].sort((a,b)=>a.order-b.order);
const i=sorted.findIndex(p=>p.id===id);
if(i<=0) return;
await swapOrder(sorted[i].id,sorted[i].order,sorted[i-1].id,sorted[i-1].order);
}

window.moveProductDown=async function(id){
const sorted=[...products].sort((a,b)=>a.order-b.order);
const i=sorted.findIndex(p=>p.id===id);
if(i===-1||i>=sorted.length-1) return;
await swapOrder(sorted[i].id,sorted[i].order,sorted[i+1].id,sorted[i+1].order);
}

/* プレビュー */
window.showPreview=function(p){
productPreview.style.display="block";
productPreview.innerHTML=`
<strong>${p.name}</strong>
<hr>
<p>${p.desc||""}</p>
${p.image?`<img src="${p.image}">`:""}
`;
}

/* Firestore監視 */
onSnapshot(query(collection(db,"categories"),orderBy("order")),snap=>{
categories=[];
productCategory.innerHTML="";
snap.forEach(d=>{
const data={id:d.id,...d.data()};
categories.push(data);
const opt=document.createElement("option");
opt.value=data.name;
opt.textContent=data.name;
productCategory.appendChild(opt);
});
});

onSnapshot(query(collection(db,"products"),orderBy("order")),snap=>{
products=[];
productList.innerHTML="";
snap.forEach(d=>{
const p={id:d.id,...d.data()};
products.push(p);

const div=document.createElement("div");
div.className="item";
div.innerHTML=`
${p.name}
<button onclick='showPreview(${JSON.stringify(p)})'>表示</button>
<button onclick='editProduct("${p.id}",${JSON.stringify(p)})'>編集</button>
<button onclick="moveProductUp('${p.id}')">▲</button>
<button onclick="moveProductDown('${p.id}')">▼</button>
<button onclick="deleteProduct('${p.id}')">削除</button>
`;
productList.appendChild(div);
});
});

window.deleteProduct=async function(id){
if(confirm("削除しますか？")){
await deleteDoc(doc(db,"products",id));
}
};

checkAutoLogin();

</script>
</body>
</html>
